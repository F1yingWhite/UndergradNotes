网络层分为数据平面和控制平面
网络层数据平面：即路由器的功能，决定如何从输入链路发送到输出链路，也就是转发
控制平面：如何控制大范围的路由，比如OSPF和BGP等协议，也就是路由
# 转发
使用最长前缀匹配原则，找到离自己匹配的最长的进行转发![[Pasted image 20240507225505.png]]
## 交换
![[Pasted image 20240507225619.png|500]]
三种交换方式
## 排队
- 输入排队，如果交换结构不能使得所有到达的分组无时延的通过那么就会出现输入端的阻塞![[Pasted image 20240507225906.png]]这种情况就叫做线路前部阻塞，
- 输出排队，当没有足够的内存来缓存一个如分组的时候，就需要做出决定，是否要丢弃新到达的分组，方法有FIFO（丢弃新到达的分组），优先权排队：有高优先级和低优先级队列，不过是不能抢占的，循环加权队列：三个队列，每个服务一定权重的时间
## IP
### IPV4
一般不要选项字段，20字节的ip头部
![[Pasted image 20240507230522.png|500]]
- 数据包长度16位，所以最长的报文2^16-1个长度
- 寿命：TTL，每过一跳-1
每一个链路层帧的最大承载数据量叫做最大传送单元MTU，一般取1500，限制ip数据包的长度
子网掩码：一个路由器接口的网络形成一个子网。IP编制为这个子网分配一个地址比如224.1.1.0/24,其中的24就是表示最左侧24位是子网地址，
![[Pasted image 20240507231140.png|500]]
### 动态主机配置协议DHCP  
一个主机如果希望得到一个ip地址，他需要使用DHCP获得临时的ip地址。DHCP是一个即插即用协议，步骤如下：
- DHCP服务器发现：发一个DHCP发现报文来看看主机是谁，使用广播地址255.255.255.255,并且使用本机源ip0.0.0.0.将IP报文发送给链路层，链路层将帧广播到该子网的所有节点
- DHCP服务器提供：DHCP服务器收到一个发现报文的时候，返回一个DHCP提供报文。服务器根据多个服务器选择最佳的服务器。每台服务器提供的报文包含有收到的发现报文的事务ID、向客户推荐的IP地址、网络掩码以及IP地址租用期, 即IP地址有效的时间量。
- DHCP请求：客户选择一个心仪的服务器，发送DHCP请求报文
- DHCP ACK：服务器发送一个DHCP报文
![[Pasted image 20240507232043.png|500]]
### 网络地址转换NAT
![[Pasted image 20240507233011.png]]
一个ip可以映射2^16个内网ip！
### IPv6
![[Pasted image 20240507233240.png]]
IPv6和IPv4的转换
包括建隧道，我们把两个IPv6中的IPv4叫做隧道，隧道可以吧IPv6放到IPv4中，隧道中的中间IPv4路由器在它们之间为该数据报提供路由，就像对待其他数据报一样，完全不知道该IPv4数据报自身就含有一个完整的 IPv6数据报。隧道端的IPv6接收到IPv4，并且确定其中包含IPv6数据包
![[Pasted image 20240507233536.png|500]]
# 路由
集中式路由选择算法：必须知道所有的链路状态信息，称为链路状态LS算法
分散式路由选择算法：没有节点拥有完整的网络链路开销管理
静态路由选择算法：路由随时间的变化非常缓慢，通常使用人工进行调整。动态路由选择算法：随着网络流量负载和拓扑关系变化而改变路径选择
## 链路状态路由选择算法
我们使用的LS算法叫第几斯特拉算法，但是该算法可能引起路由的震荡
我们还有距离向量路由选择算法（DV算法），这是一种分赛式路由选择算法，分布式，迭代，异步![[Pasted image 20240508103039.png|700]]
## 因特网中自治系统内部的路由选择
我们吧路由都变成一个一个的自治系统AS，然后由AS管理自己的路由
### OSPF开放最短路优先：
ospf是一种链路状态协议，它使用洪泛链路状态信息和Dijkstra最低开销路径算法。 使用OSPF, —台路由器构建了一幅关于整个自治系统的完整拓扑图（即一幅图），各条链路的开销可以由管理员自己指定
## ISP之间的路由选择
### BGP
在网络中，所有的AS运行着相同的AS间路由选择协议，即边界网关协议
路由器具有：
- 从邻居AS中获得前缀的可达性信息
- 确定到达该前缀的最好的路由
每台路由器要么是边界网关路由器，要么是内部路由器，跨AS的叫做外BGP，内部的叫做内部BGP，使用半永久TCP链接![[Pasted image 20240508110050.png]]
对于可达性就如同泛洪一样传播过去。当然可能同时有多个可达路径，那我们如何选择做好的那个？
#### 热土豆路由
对于路由器，应该尽快的把分组送出AS，而不用担心AS外部到目的地的开销

### 路由选择策略

### IP任传波

