早期cpu直接处理IO的输入,
DMA技术:直接存储器存取DMA技术让IO设备直接和主存交换信息,绕过了CPU,使得CPU的使用效率进一步加强
大型机器中,使用DMA会导致一些数据冲突的问题,因此又出现了通道,通道负责管理IO设备以及实现主存和IO设备交换信息,能够独立的使用通道指令编写输入输出程序![[Pasted image 20240513174122.png]]
第四个阶段中,出现了IO处理机,基本独立于本机工作,可以完成IO控制/编码交换等任务
# 输入输出系统的组成
由软件和硬件两部分组成
## 软件
IO软件:将用户编制的程序输入主机内,将运算结果给用户,实现输入输出系统和主机的协调.
IO指令:IO指令是机器指令的一种,由[操作码|命令码|设备码]组成,可以和其他机器指令的字长相等.可以吧数据从IO设备送给主机,也可以吧数据给IO设备,可以形成某些操作,比如读写文件扫描磁道等
通道指令:幼教通道控制字,用于执行IO操作,如读写寻道等操作.对于有通道指令的计算机,一旦CPU执行了启动IO设备的指令,就由通道管理IO设备
## 硬件
一个通道可以和一个以上的设备控制器相连,一个设备控制器又可以控制多个同类型设备,比如6通道,一个通道8个设备控制器,一个设备控制器又和8个设备相连,那一共384个设备
## 联系方式
- 地址编码方式:IO设备通常看做地址码,可以进行统一编质(吧IO看做存储地址的一部分,比如64k的存储空间划出8k给IO,这8k地址的访问就是对IO的操作)或者不统一(不统一IO地址就是分开的,由专门的IO设备访问请求控制).
- 设备寻址:每台设备一个设备号,当要启动某一设备,IO指令的设备码字段指出对应的设备.
- 传送方式:n位信息会同时从CPU输出到IO设备或者反过来,这种方法叫做并行;1比特1比特叫做串行,只需要一根线,适用于远距离通信
- 联络方式:
	- 立即响应:对于工作缓慢的IO设备比如指示灯,他们与CPU发生联系一般都在等待,因此只要IO命令一到,立刻响应
	- 异步工作:当IO与CPU工作速度不一致,就采用异步工作.IO与CPU完成自己的任务,一旦出现联络信号,才准备交换数据,当返回strobe的时候信息已被取走!![[Pasted image 20240513175754.png]]
	- 同步工作:要求IO与CPU工作速度完全同步,
## IO设备与主机交换信息的控制方式
1. 程序查询:由CPU通过程序不断查询IO设备是否已经做好准备,从而控制IO设备与主机交换信息,要求IO设备有一个反应IO设备是否做好准备的标记
2. 程序中断:IO设备准备就绪并发向CPU发送中断请求的时候才响应,大大提升了CPU的工作效率.程序进行一个中断请求,然后挂起当前执行的程序,操作完中断服务后恢复上下文![[Pasted image 20240513180251.png]]
3. DMA方式:中断方式消除了程序的踏步,但是必须中断现在的程序,就出现了DMA.主存和IO设备有一个数据通路,如果DMA和CPU同时访问主存,那么CPU总是把总线让给DMA,这个叫周期窃取,但是在消失的这个周期中CPU还可以运作,进一步提升了效率
# 程序中断的概念
中断就是cpu停止现行程序的运行,转向对这些异常情况/特殊请求的处理,当处理结束后再返回现行程序的间断处重新运行
cpu在任何时候只能接受一个中断,当多个中断的时候,CPU只接受最高等级的中断.且总是在每条指令执行的最后时刻查询所有设备是否有中断.通过MASK屏蔽触发器,当其为1的时候封锁所有其他中断源的请求.
排队器:多个中断同时发生的时候,CPU按照中断源的优先级排队
中断向量地址形成部件:cpu一旦响应的IO中断,就要暂停现行程序,转去执行中断服务.所有的中断服务有一个入口地址,cpu必须先找到这个入口地址.
硬件向量法:通过向量地址来寻找设备的中断服务程序的入口地址,而且向量地址是硬件电路产生的,一个中断源对应一个不同的地址向量
## IO中断处理过程
1. cpu发送io指令
2. 接口启动输入设备
3. 输入设备把数据放入缓存寄存器
4. 输入设备向接口发送工作结束信号
5. 当设备准备就绪切本设备未被屏蔽(mask=0)的时候,在指令执行阶段结束的时刻,cpu立刻发送中断查询
6. 设备中断请求触发器INTR被设为1,并且向CPU提出**中断请求**,同时INTR被送到排队器,进行中断判优
7. 如果CPU允许中断,那么进入中断响应阶段,形成向量地址
8. 向量地址传送到PC,作为下一条指令的地址
9. 由于向量地址是无条件转移,立刻跳转到服务程序入口,进入中断服务
## 中断服务程序的流程
1. 保护现场:将所有的寄存器状态信息保护起来放进堆栈
2. 中断服务:
3. 恢复现场
4. 中断返回
# DMA方式
## DMA方式的特点
主存和DMA接口之间有一条数据通路,不用经过CPU这种特点特别适合告诉IO与主存交换信息
![[Pasted image 20240513184326.png]]
在DMA中,因为DMA和CPU共享主存,有可能出现两者竞争主存的情况,有三种方法
1. 停止CPU访问主存,这种方法简单但是CPU这期间基本不可用
2. 周期窃取:IO设备窃取总线使用权几个周期,
	1. 当cpu不需要访问主存,不会冲突
	2. cpu正在访问,必须等待存取周期结束mcpu才能把总线占有权让出
	3. io优先访问主存的时候,如果io不立即访问主存就会导致数据丢失.那么就需要挪用几个CPU使用周期
3. DMA与CPU交替访问,这种情况适用于CPU工作周期比主存存取周期长,比如CPU周期为1.2us,主存存取为0.6us,那么可以分为俩周期,一个DMA一个CPU.因为不涉及总线的归还之类,所有速度快,但是物理复杂.

>  一个DMA使用周期窃取的方式.它支持的最大批量为400个字节。若存取周期为100ns,每处理一次中断需5μs,现有的字符设备的传输率为9600 bps。假设字符之间的传输是无间隙的，若忽略预处理所需的时间，试问采用 DMA方式每 秒因数据传输需占用处理器多少时间?如果完全采用中断方式，又需占用处理器多少时间

解:一共1200个字节,1200个字符需要1200个存取周期,每400个字符一次中断,因此需要$3*5us+1200*0.1us$,而中断方式每个字节一次中断,需要$5us*1200$
因为存取周期的时候cpu不能干活?

